<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- Global preconditions to ensure database compatibility -->
    <preConditions onFail="HALT">
        <dbms type="mysql,postgresql,oracle,h2"/>
    </preConditions>

    <!-- This is a global comment. It provides context or additional information for the entire changelog. -->
    <!-- Example: This changelog contains table creation scripts for the rate packages and group management system. -->
    <!--
        This changeset follows the format:
        <UserID><Date (DDMMYYYY)>-<UserSpecificCount>-<TotalChangesetCount>
        Example: HR30072025-01-0001
    -->

    <!-- ✅ Create 'role' table -->
    <changeSet id="GS_22082025-001-0001" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="role"/>
            </not>
        </preConditions>

        <createTable tableName="role">
            <column name="role_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="role_name" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <rollback>
            <dropTable tableName="role"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create 'user' table -->
    <changeSet id="GS_22082025-002-0002" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="role"/>
                <not>
                    <tableExists tableName="user"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="user">
            <column name="user_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(100)"/>
            <column name="phone" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="is_guest" type="BIT" defaultValueBoolean="false"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <!-- Removed role_id column as it conflicts with user_roles many-to-many relationship -->
        </createTable>

        <rollback>
            <dropTable tableName="user"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create user_roles junction table -->
    <changeSet id="GS_22082025-003-0003" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="user"/>
                <tableExists tableName="role"/>
                <not>
                    <tableExists tableName="user_roles"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="user_roles">
            <column name="user_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign keys -->
        <addForeignKeyConstraint baseTableName="user_roles"
                                 baseColumnNames="user_id"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 constraintName="fk_user_roles_user"/>

        <addForeignKeyConstraint baseTableName="user_roles"
                                 baseColumnNames="role_id"
                                 referencedTableName="role"
                                 referencedColumnNames="role_id"
                                 constraintName="fk_user_roles_role"/>

        <!-- Composite primary key to prevent duplicate role assignments -->
        <addPrimaryKey tableName="user_roles"
                       columnNames="user_id, role_id"
                       constraintName="pk_user_roles"/>

        <rollback>
            <dropTable tableName="user_roles"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create 'vehicle_detail' table (based on VehicleDetail entity) -->
    <changeSet id="GS_22082025-004-0004" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="user"/>
                <not>
                    <tableExists tableName="vehicle_detail"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="vehicle_detail">
            <column name="vehicle_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="vehicle_type" type="VARCHAR(50)"/>
            <column name="vehicle_number" type="VARCHAR(20)"/>
            <column name="model" type="VARCHAR(100)"/>
            <column name="owner_id" type="BIGINT UNSIGNED"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="vehicle_detail"
                                 baseColumnNames="owner_id"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 constraintName="fk_vehicle_detail_owner"/>

        <rollback>
            <dropTable tableName="vehicle_detail"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create 'service' table -->
    <changeSet id="GS_22082025-005-0005" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="vehicle_detail"/>
                <not>
                    <tableExists tableName="service"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="service">
            <column name="service_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="vehicle_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="service_name" type="VARCHAR(100)"/>
            <column name="description" type="CLOB"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="service"
                                 baseColumnNames="vehicle_id"
                                 referencedTableName="vehicle_detail"
                                 referencedColumnNames="vehicle_id"
                                 constraintName="fk_service_vehicle"/>

        <rollback>
            <dropTable tableName="service"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create rate_table -->
    <changeSet id="GS_22082025-006-0006" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="service"/>
                <not>
                    <tableExists tableName="rate_table"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="rate_table">
            <column name="rate_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="service_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="unit_type" type="VARCHAR(50)"/>
            <column name="rate_amount" type="DECIMAL(10,2)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="rate_table"
                                 baseColumnNames="service_id"
                                 referencedTableName="service"
                                 referencedColumnNames="service_id"
                                 constraintName="fk_rate_service"/>

        <rollback>
            <dropTable tableName="rate_table"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create booking table -->
    <changeSet id="GS_23082025-007-0007" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="user"/>
                <tableExists tableName="service"/>
                <tableExists tableName="vehicle_detail"/>
                <not>
                    <tableExists tableName="booking"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="booking">
            <column name="booking_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="farmer_id" type="BIGINT UNSIGNED"/>
            <column name="service_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="vehicle_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>

            <column name="expected_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="farmer_name" type="VARCHAR(100)"/>
            <column name="farmer_phone" type="VARCHAR(20)"/>

            <column name="status" type="VARCHAR(20)" defaultValue="Pending"/>

            <!-- ✅ New Fields -->
            <column name="acres" type="DOUBLE"/>
            <column name="guntas" type="DOUBLE"/>
            <column name="hours" type="INT"/>
            <column name="minutes" type="INT"/>
            <column name="kilometers" type="DOUBLE"/>
            <column name="payment_time" type="TIMESTAMP"/>

            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign Keys -->
        <addForeignKeyConstraint baseTableName="booking"
                                 baseColumnNames="farmer_id"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 constraintName="fk_booking_farmer"/>

        <addForeignKeyConstraint baseTableName="booking"
                                 baseColumnNames="service_id"
                                 referencedTableName="service"
                                 referencedColumnNames="service_id"
                                 constraintName="fk_booking_service"/>

        <addForeignKeyConstraint baseTableName="booking"
                                 baseColumnNames="vehicle_id"
                                 referencedTableName="vehicle_detail"
                                 referencedColumnNames="vehicle_id"
                                 constraintName="fk_booking_vehicle"/>

        <rollback>
            <dropTable tableName="booking"/>
        </rollback>
    </changeSet>


    <!-- ✅ Create queue table -->
    <changeSet id="GS_22082025-008-0008" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="booking"/>
                <not>
                    <tableExists tableName="queue"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="queue">
            <column name="queue_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="booking_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="position_no" type="INT"/>
            <column name="adjusted" type="BIT" defaultValueBoolean="false"/>
            <column name="scheduled_date" type="TIMESTAMP"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="queue"
                                 baseColumnNames="booking_id"
                                 referencedTableName="booking"
                                 referencedColumnNames="booking_id"
                                 constraintName="fk_queue_booking"/>

        <rollback>
            <dropTable tableName="queue"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create payment table -->
    <changeSet id="GS_22082025-009-0009" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="booking"/>
                <not>
                    <tableExists tableName="payment"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="payment">
            <column name="payment_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="booking_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="Pending"/>
            <column name="mode" type="VARCHAR(20)" defaultValue="CASH"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="payment"
                                 baseColumnNames="booking_id"
                                 referencedTableName="booking"
                                 referencedColumnNames="booking_id"
                                 constraintName="fk_payment_booking"/>

        <rollback>
            <dropTable tableName="payment"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create payment_settlement table -->
    <changeSet id="GS_22082025-010-0010" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="payment"/>
                <not>
                    <tableExists tableName="payment_settlement"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="payment_settlement">
            <column name="settlement_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="payment_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="actual_paid_amount" type="DECIMAL(10,2)"/>
            <column name="remarks" type="CLOB"/>
            <column name="settlement_date" type="TIMESTAMP"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="payment_settlement"
                                 baseColumnNames="payment_id"
                                 referencedTableName="payment"
                                 referencedColumnNames="payment_id"
                                 constraintName="fk_settlement_payment"/>

        <rollback>
            <dropTable tableName="payment_settlement"/>
        </rollback>
    </changeSet>

    <!-- ✅ Create expenses table -->
    <changeSet id="GS_22082025-011-0011" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="user"/>
                <tableExists tableName="vehicle_detail"/>
                <not>
                    <tableExists tableName="expenses"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="expenses">
            <column name="expense_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>

            <column name="owner_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>

            <column name="vehicle_id" type="BIGINT UNSIGNED">
                <constraints nullable="true"/>
            </column>

            <column name="description" type="VARCHAR(255)"/>

            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="expense_date" type="TIMESTAMP"/>

            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign key to owner -->
        <addForeignKeyConstraint baseTableName="expenses"
                                 baseColumnNames="owner_id"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 constraintName="fk_expense_owner"/>

        <!-- ✅ Foreign key to vehicle -->
        <addForeignKeyConstraint baseTableName="expenses"
                                 baseColumnNames="vehicle_id"
                                 referencedTableName="vehicle_detail"
                                 referencedColumnNames="vehicle_id"
                                 constraintName="fk_expense_vehicle"/>

        <rollback>
            <dropTable tableName="expenses"/>
        </rollback>
    </changeSet>


    <!-- ✅ Create notification table -->
    <changeSet id="GS_22082025-012-0012" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="user"/>
                <not>
                    <tableExists tableName="notification"/>
                </not>
            </and>
        </preConditions>

        <createTable tableName="notification">
            <column name="notification_id" type="BIGINT UNSIGNED" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="BIGINT UNSIGNED">
                <constraints nullable="false"/>
            </column>
            <column name="booking_id" type="BIGINT UNSIGNED"/>
            <column name="type" type="VARCHAR(20)"/>
            <column name="message" type="CLOB"/>
            <column name="status" type="VARCHAR(20)" defaultValue="Sent"/>
            <column name="is_deleted" type="BIT" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="notification"
                                 baseColumnNames="user_id"
                                 referencedTableName="user"
                                 referencedColumnNames="user_id"
                                 constraintName="fk_notification_user"/>

        <addForeignKeyConstraint baseTableName="notification"
                                 baseColumnNames="booking_id"
                                 referencedTableName="booking"
                                 referencedColumnNames="booking_id"
                                 constraintName="fk_notification_booking"/>

        <rollback>
            <dropTable tableName="notification"/>
        </rollback>
    </changeSet>

    <changeSet id="GS_23082025-013-0013" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="rate_table" columnName="sub_unit_type"/>
            </not>
        </preConditions>

        <addColumn tableName="rate_table">
            <column name="sub_unit_type" type="varchar(50)"/>
        </addColumn>
    </changeSet>

    <changeSet id="GS_23082025-014-0014" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="booking" columnName="meters"/>
            </not>
        </preConditions>

        <addColumn tableName="booking">
            <column name="meters" type="DOUBLE"/>
        </addColumn>
    </changeSet>

    <changeSet id="GS_23082025-015-0015" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="booking" columnName="reference_id"/>
            </not>
        </preConditions>

        <addColumn tableName="booking">
            <column name="reference_id" type="VARCHAR(20)"/>
        </addColumn>
    </changeSet>
    <changeSet id="GS_25082025-016-0016" author="GOVIND SIRSATH">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="payment_settlement"/>
        </preConditions>

        <!-- Add receipt number for manual cash reference -->
        <addColumn tableName="payment_settlement">
            <column name="receipt_number" type="VARCHAR(100)"/>
        </addColumn>

        <!-- Installment and partial payment tracking -->
        <addColumn tableName="payment_settlement">
            <column name="installment_number" type="INT"/>
            <column name="is_partial_payment" type="BIT" defaultValueBoolean="false"/>
            <column name="payment_date" type="TIMESTAMP"/>
            <column name="total_paid_so_far" type="DECIMAL(10,2)"/>
        </addColumn>

        <!-- Status and transaction type -->
        <addColumn tableName="payment_settlement">
            <column name="settlement_status" type="VARCHAR(30)"/>
            <column name="transaction_type" type="VARCHAR(30)"/>
        </addColumn>

        <!-- Refund related fields -->
        <addColumn tableName="payment_settlement">
            <column name="refund_amount" type="DECIMAL(10,2)"/>
            <column name="refund_date" type="TIMESTAMP"/>
            <column name="refund_reason" type="VARCHAR(255)"/>
        </addColumn>

        <!-- Extra financial fields -->
        <addColumn tableName="payment_settlement">
            <column name="extra_earned_amount" type="DECIMAL(10,2)" defaultValueNumeric="0.00"/>
            <column name="remaining_amount" type="DECIMAL(10,2)"/>
            <column name="mark_fully_paid" type="BIT" defaultValueBoolean="false"/>
        </addColumn>

        <!-- Collected and refunded by -->
        <addColumn tableName="payment_settlement">
            <column name="collected_by" type="VARCHAR(100)"/>
            <column name="refunded_by" type="VARCHAR(100)"/>
        </addColumn>

        <!-- Audit fields -->
        <addColumn tableName="payment_settlement">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>

        <rollback>
            <dropColumn tableName="payment_settlement" columnName="receipt_number"/>
            <dropColumn tableName="payment_settlement" columnName="installment_number"/>
            <dropColumn tableName="payment_settlement" columnName="is_partial_payment"/>
            <dropColumn tableName="payment_settlement" columnName="payment_date"/>
            <dropColumn tableName="payment_settlement" columnName="total_paid_so_far"/>
            <dropColumn tableName="payment_settlement" columnName="settlement_status"/>
            <dropColumn tableName="payment_settlement" columnName="transaction_type"/>
            <dropColumn tableName="payment_settlement" columnName="refund_amount"/>
            <dropColumn tableName="payment_settlement" columnName="refund_date"/>
            <dropColumn tableName="payment_settlement" columnName="refund_reason"/>
            <dropColumn tableName="payment_settlement" columnName="extra_earned_amount"/>
            <dropColumn tableName="payment_settlement" columnName="remaining_amount"/>
            <dropColumn tableName="payment_settlement" columnName="mark_fully_paid"/>
            <dropColumn tableName="payment_settlement" columnName="collected_by"/>
            <dropColumn tableName="payment_settlement" columnName="refunded_by"/>
            <dropColumn tableName="payment_settlement" columnName="created_at"/>
            <dropColumn tableName="payment_settlement" columnName="updated_at"/>
        </rollback>
    </changeSet>



</databaseChangeLog>
